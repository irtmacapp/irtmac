"use client";
import Link from "next/link";
import { useCallback, useEffect, useRef, useState } from "react";
import { RxHamburgerMenu } from "react-icons/rx";
import { IoMdClose } from "react-icons/io";

import { FaChevronDown } from "react-icons/fa6";
import { FaChevronUp } from "react-icons/fa";
import Lang from "./Lang";
import Search from "../../global_containers/Search";
import { usePathname, useRouter, useSearchParams } from "next/navigation";
import DOMPurify from "isomorphic-dompurify";
import MaxWidth from "../../MaxWidth/MaxWidth";
const Header = ({ params, data_translate, data_footer }) => {
  const [scrolledFromTop, setScrollTop] = useState(false);
  const [portfolio, setPortfolio] = useState([]);
  const [services, setServices] = useState([]);
  const [blogs, setBlogs] = useState([]);
  const router = useRouter();

  const mobileRef = useRef();
  const searchParams = useSearchParams();
  const overlayDiv = useRef();
  const serachComponent = useRef();
  const searchInputRef = useRef();
  const [searchInput, setSearchInput] = useState("");
  const [openCategory, setOpenCategory] = useState(null);

  const [loading, setLoading] = useState(false);
  const [open, setOpen] = useState(false);
  const activePage = usePathname();

  const mobileHeader = [
    {
      id: 1,
      title: `${data_translate?.header_1_text}`,
      href: `/${params?.code}`,
    },
    {
      id: 2,
      title: `${data_translate?.header_2_text}`,
      href: `/${params?.code}/haqqimizda`,
    },
    {
      id: 3,
      title: `${data_translate?.header_3_text}`,
      href: `/${params?.code}/telimler`,
    },
    {
      id: 4,
      title: `${data_translate?.header_4_text}`,
      href: `/${params?.code}/telimciler`,
    },
    {
      id: 5,
      title: `${data_translate?.header_5_text}`,
      href: `/${params?.code}/media-merkezi`,
    },
    {
      id: 6,
      title: `${data_translate?.header_6_text}`,
      href: `/${params?.code}/elaqe`,
    },
  ];

  const handleOpen = (name) => () => {
    setOpenCategory((prev) => (prev === name ? null : name));
  };

  useEffect(() => {
    if (searchInput && searchInput.trim() !== "") {
      setLoading(true);
      const delay = setTimeout(() => {
        fetch(
          `${process.env.NEXT_PUBLIC_MAIN_URL}/${params?.code}/search?q=${searchInput}`
        )
          .then((res) => res.json())
          .then((data) => {
            setBlogs(data?.blogs);
            setPortfolio(data?.portfolios);
            setServices(data?.services);
          })
          .finally(() => setLoading(false));
      }, 1000);

      return () => clearTimeout(delay);
    } else {
      setLoading(false);
      setPortfolio([]);
      setServices([]);
      setBlogs([]);
    }
  }, [searchInput]);

  useEffect(() => {
    if (typeof window !== "undefined") {
      window.addEventListener("scroll", scrollHandler);
    }

    return function () {
      if (typeof window !== "undefined") {
        window.removeEventListener("scroll", scrollHandler);
      }
    };
  }, []);
  function scrollHandler(event) {
    if (typeof window !== "undefined") {
      window.pageYOffset >= 50 ? setScrollTop(true) : setScrollTop(false);
    }
  }

  function openSearch() {
    const serach = serachComponent?.current?.classList;
    if (serach.contains("top-[-100%]")) {
      serach?.replace("top-[-100%]", "top-0");
      overlayDiv?.current?.classList?.add("active");
    }
    searchInputRef.current.focus();

    setSearchInput("");
  }

  function closeSearch() {
    const serach = serachComponent?.current?.classList;
    if (serach.contains("top-0")) {
      serach?.replace("top-0", "top-[-100%]");
      overlayDiv?.current?.classList?.remove("active");
    }

    setSearchInput("");
  }

  function openMobileMenu() {
    const menuClassList = mobileRef?.current?.classList;
    if (menuClassList?.contains("left-[-100%]")) {
      menuClassList?.replace("left-[-100%]", "left-0");
      overlayDiv?.current?.classList?.add("active");
      if (typeof window !== "undefined") {
        let html = document.querySelector("html");
        html.classList.add("active");
      }
    }
  }
  function closeMobileMenu() {
    const menuClassList = mobileRef?.current?.classList;
    if (menuClassList?.contains("left-0")) {
      menuClassList?.replace("left-0", "left-[-100%]");
      overlayDiv?.current?.classList?.remove("active");
      if (typeof window !== "undefined") {
        let html = document.querySelector("html");
        html.classList.remove("active");
      }
    }
    closeSearch();
  }

  useEffect(() => {
    const menuClassList = mobileRef?.current?.classList;
    if (activePage !== "/" || activePage === "/") {
      menuClassList?.replace("left-0", "left-[-100%]");
      setOpen(false);
      overlayDiv?.current?.classList?.remove("active");
    }
  }, [activePage]);

  let language;
  if (typeof window !== "undefined") {
    language = localStorage.getItem("i18nextLng");
    let html = document.querySelector("html");
    html.classList.remove("active");
  }

  const langSwitcher = async () => {
    setOpen(false);
  };
  const langs = ["az", "en", "ru"];

  const langChecker = useCallback((lang = "az") => {
    if (typeof localStorage !== "undefined") {
      return lang !== localStorage.getItem("i18nextLng");
    }
  }, []);

  const myLang = langs?.filter(langChecker);

  const createQueryString = useCallback(
    (name, value) => {
      const params =
        searchParams !== undefined
          ? new URLSearchParams(searchParams || undefined)
          : "";
      params?.set(name, value);
      return params.toString();
    },
    [searchParams]
  );

  const onCodeClose = (e) => {
    if (e.keyCode === 27) {
      closeSearch();
      setPortfolio([]);
      setServices([]);
      setBlogs([]);
    } else if (e.keyCode === 13) {
      closeSearch();
      const query =
        searchInput !== undefined ? createQueryString("q", searchInput) : "";
      router.push(`/${params?.code}/search/?${query}`);
    }
  };
  const pathname = usePathname();

  return (
    <>
      <header className="bg-[#002D74]  py-[25px]">
        <MaxWidth>
          <div className="flex justify-between items-center">
            <p className="text-white text-[14px]">
              {data_footer?.settings?.description}
            </p>
            <div className="flex gap-[20px] items-center">
              <button
                onClick={openSearch}
                className=" px-4 py-2  cursor-pointer "
              >
                <img
                  className="w-[20px]"
                  src="/header_search.svg"
                  alt="search"
                />
              </button>
              <div>
                <Lang
                  toggle={() => setOpen(!open)}
                  langs={langs}
                  scrolledFromTop={scrolledFromTop}
                  switchLang={
                    open && (
                      <div className="absolute  mt-6 right-[-30px] top-[8px] h-[50px] z-50   flex flex-col text-left items-center justify-center ">
                        {myLang?.map((lang, index) => (
                          <button
                            className={`z-[200] capitalize 0 text-[15px] xl:text-[13px]  transitions  overflow-hidden px-6 py-1 rounded-lg text-white`}
                            key={index}
                            onClick={() => langSwitcher(lang)}
                          >
                            {lang}
                          </button>
                        ))}
                      </div>
                    )
                  }
                />
              </div>
            </div>
          </div>
        </MaxWidth>
      </header>
      <div
        onClick={closeMobileMenu}
        ref={overlayDiv}
        className="mobile-menu-overlay overflow-x-hidden block fixed left-0 top-0 bottom-0 right-0 z-[100] overlay "
      />
      <header
        className={` w-full   rounded-br-[20px] rounded-bl-[20px]  top-0 left-0 right-0 header-tr z-[300] bg-[#009ADE] 
           ${scrolledFromTop ? "fixed py-[26px]" : "py-[46px]"}`}
      >
        <MaxWidth>
          <nav className="  flex justify-between  ">
            <div className="  flex items-center justify-center lg:pl-4">
              <Link href={`/${params?.code}`}>
                <img
                  src={`${process.env.NEXT_PUBLIC_PICTURE}/${data_footer?.settings?.logob}`}
                  alt="header_logo_white"
                  className="w-[212px] 2xl:w-[120px] xl:w-[80px] object-cover"
                />
              </Link>
            </div>
            <div className="left  flex justify-start lg:hidden">
              <ul className="flex items-center gap-2 uppercase font-normal header-colors 2xl:pr-[40px] xl:pr-[0px]">
                {mobileHeader?.map((item) => {
                  const isActive = pathname === item.href;

                  return (
                    <li
                      key={item.id}
                      className="px-4 xl:px-2 2xl:px-2 child_li w-max relative text-white font-['TTForsTrial-Medium']"
                    >
                      <Link className="w-max text-[14px]" href={item.href}>
                        {item.title}
                      </Link>

                      {isActive && (
                        <span className="absolute left-[50%] translate-x-[-50%] -bottom-3 w-[48px]  h-[2px] bg-[#002D74]"></span>
                      )}
                    </li>
                  );
                })}
              </ul>
            </div>
            <div>
              <Link
                href={`/${params?.code}/telimciler`}
                className="bg-[#fff] py-[15px] px-[36px] text-[16px] uppercase text-['#002D74'] font-['TTForsTrial-Medium'] rounded-[60px]"
              >
                {data_translate?.header_4_text}
              </Link>
            </div>

            <div className=" items-center lg:gap-5 hidden lg:flex">
              <div
                onClick={openSearch}
                className="px-4 py-2 hidden lg:block child_li cursor-pointer border-[2px] border-[#E9ECF4] rounded-[48px] p-[2px]"
              >
                <img src="/search-blue.svg" className="w-[15px]" alt="search" />
              </div>
              <div className="w-max hidden lg:block ">
                <Lang
                  toggle={() => setOpen(!open)}
                  langs={langs}
                  scrolledFromTop={scrolledFromTop}
                  switchLang={
                    open && (
                      <div className="absolute  mt-6 right-[-30px] top-[8px] h-[50px] flex flex-col text-left items-center justify-center ">
                        {myLang?.map((lang, index) => (
                          <button
                            className={` z-[200] capitalize text-[15px] xl:text-[13px] transitions border border-solid border-blue_gray-100 overflow-hidden px-6 py-1 rounded-lg bg-white-A700 hover:bg-[#5D9733] tran hover:text-white-A700 `}
                            key={index}
                            onClick={() => langSwitcher(lang)}
                          >
                            {lang}
                          </button>
                        ))}
                      </div>
                    )
                  }
                />
              </div>
              <div
                onClick={openMobileMenu}
                className="burger hidden lg:block mobile_header_open"
              >
                <RxHamburgerMenu className="text-2xl cursor-pointer" />
              </div>
            </div>
          </nav>
        </MaxWidth>
      </header>
      <div
        ref={mobileRef}
        className="mobile-menu fixed top-0 pt-28 pl-16 left-[-100%] z-[1000] h-full w-[400px] md:w-full bg-white trans  "
      >
        <p
          onClick={closeMobileMenu}
          className="absolute top-10 right-10 cursor-pointer"
        >
          <IoMdClose className="text-2xl" />
        </p>
        <ul className="flex flex-col gap-2">
          {mobileHeader &&
            mobileHeader?.map((cur, i) => {
              return (
                <li
                  key={i}
                  onClick={handleOpen(cur?.title)}
                  className="relative"
                >
                  {cur?.href === null ? (
                    <h3 className=" flex text-lg capitalize items-center gap-2 cursor-pointer trans hover:text-[#003B71]">
                      {cur?.title}
                      <span>
                        {openCategory === cur?.title ? (
                          <FaChevronUp className="text-sm" />
                        ) : (
                          <FaChevronDown className="text-sm" />
                        )}
                      </span>
                    </h3>
                  ) : (
                    <Link
                      className="text-lg capitalize trans hover:text-[#003B71]"
                      href={`/${cur?.href}`}
                    >
                      {cur?.title}
                    </Link>
                  )}
                  {cur?.subMenu !== null && (
                    <ul
                      className={`trans gap-3 ${
                        openCategory === cur?.title
                          ? "flex visible h-full flex-col mt-3  ml-2  mb-3 "
                          : " invisible h-0"
                      }`}
                    >
                      {cur &&
                        openCategory === cur?.title &&
                        cur?.subMenu?.map((elem, i) => {
                          return (
                            <li
                              className="cursor-pointer trans hover:text-[#003B71]"
                              key={i}
                            >
                              <Link
                                href={`/${params?.code}/${elem?.href}`}
                                className="flex h-full w-full capitalize"
                              >
                                {elem?.title}
                              </Link>
                            </li>
                          );
                        })}
                    </ul>
                  )}
                </li>
              );
            })}
        </ul>
      </div>
      <div
        ref={serachComponent}
        className="fixed top-[-100%] left-0 right-0 w-full bg-white  py-6 z-[500] trans "
      >
        <div className="relative mx-8 lg:mx-3">
          <span className="absolute top-3 left-4">
            <img src="/search-lg.svg" alt="search" />
          </span>
          <input
            value={searchInput}
            ref={searchInputRef}
            onKeyUp={(e) => onCodeClose(e)}
            onChange={(e) => setSearchInput(e.target.value)}
            placeholder={data_translate?.search}
            type="text"
            className="w-full border border-[#E9ECF4] rounded-full py-3 pl-12 pr-10 shadow-none outline-none"
          />
          <span
            onClick={closeSearch}
            className="absolute top-[18px] right-4 cursor-pointer"
          >
            <img src="/close.svg" alt="close" />
          </span>
        </div>
        <Search
          notFound={!portfolio?.length && !services?.length && !blogs?.length}
          loading={loading}
          inputValue={searchInput}
          portfolio={portfolio}
          services={services}
          blogs={blogs}
          closeSearch={closeSearch}
          netice={data_translate?.netice}
          params={params}
        />
      </div>
    </>
  );
};

export default Header;
